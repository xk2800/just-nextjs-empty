name: Deploy to Pi

on:
  push:
    branches: ["master"]

jobs:
  # JOB 1: Build on GitHub's fast servers
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1 # or actions/setup-node
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build Standalone
        run: bun run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      # Pack the standalone build
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next/standalone
            .next/static
            public

  # JOB 2: Deploy on your Pi Zero 2 (Self-Hosted Runner)
  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - name: Stop App
        run: pm2 stop next-app || true

      - name: Clean Old Files
        run: rm -rf /home/admin/test-app/*

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: /home/admin/test-app

      # Move static files to correct location for standalone
      - name: Organize Files
        run: |
          mkdir -p /home/admin/test-app/.next/static
          mv /home/admin/test-app/.next/static /home/admin/test-app/.next/standalone/.next/
          cp -r /home/admin/test-app/public /home/admin/test-app/.next/standalone/

      - name: Install Production Deps (minimal)
        working-directory: /home/admin/test-app/.next/standalone
        run: bun install --production # Usually not needed for standalone, but good safety

      - name: Start App
        working-directory: /home/admin/test-app/.next/standalone
        run: |
          pm2 restart next-app || pm2 start server.js --name next-app --interpreter bun
          pm2 save
